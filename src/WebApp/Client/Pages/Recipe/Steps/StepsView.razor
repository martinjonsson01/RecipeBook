@using RecipeBook.Core.Domain.Recipes
@using System.Collections.ObjectModel

<div class="ms-5">
    <FetchList TItem="Step"
               Context="steps"
               Url="@($"/api/v1/recipes/{RecipeName}/steps")"
               SetSaving="@SetSaving">
        <Header>
            <h2>Steg</h2>
        </Header>
        <ItemsTemplate>
            <ol class="no-style ps-2">
                @foreach (Step step in steps!)
                {
                    <li @key="@step.Id" 
                        id="@step.Id"
                        draggable="true" 
                        @ondragstart="() => StartDrag(steps!, step)"
                        @ondragend="() => Drop(steps!, step)"
                        @ondragenter="() => Hover(steps!, step)"
                        ondragover="window.interopFunctions.dropEffectMovable(event)"
                        ondragleave="window.interopFunctions.highlightDragLeave(event, this, @step.Id)"
                        class="@(_hoveringIndex == steps.IndexOf(step) ? "highlighted" : "")">
                        @switch (step)
                        {
                            case TimeStep timeStep:
                                <StepView Url="@($"/api/v1/recipes/{RecipeName}/steps")"
                                          Step="@timeStep"
                                          SetSaving="@SetSaving"
                                          DeleteItem="() => DeleteStep(steps, timeStep)">
                                    <TimerView Duration="timeStep.Duration"/>
                                </StepView>
                                break;
                            default:
                                <StepView Url="@($"/api/v1/recipes/{RecipeName}/steps")"
                                          Step="@step"
                                          SetSaving="@SetSaving"
                                          DeleteItem="() => DeleteStep(steps, step)"/>
                                break;
                        }
                    </li>
                }
            </ol>
        </ItemsTemplate>
        <CreateNewButtonTemplate Context="steps">
            <CreateNewItemButton Items="steps"
                                 CreateNewItem="CreateNewStep"
                                 CreateNewItemText="Lägg till steg"/>
        </CreateNewButtonTemplate>
    </FetchList>
</div>

@code {
#nullable enable

    [Parameter]
    public string RecipeName { get; set; } = null!;

    [Parameter]
    public EventCallback<(string, LoadStatus)> SetSaving { get; set; } = EventCallback<(string, LoadStatus)>.Empty;

    private Step CreateNewStep(int number)
    {
        return new() { Number = number, Instruction = "Skriv instruktion här" };
    }

    private void DeleteStep(ICollection<Step> steps, Step toRemove)
    {
        UpdateStepNumbering(steps, toRemove);
        steps.Remove(toRemove);
    }

    private void UpdateStepNumbering(ICollection<Step> steps, Step? toIgnore = null)
    {
        var number = 1;
        foreach (var step in steps)
        {
            if (step.Equals(toIgnore)) continue;
            step.Number = number++;
        }
    }

    private int _draggingIndex = -1;
    private int _hoveringIndex = -1;

    private void StartDrag(ObservableCollection<Step> steps, Step step)
    {
        _draggingIndex = steps.IndexOf(step);
    }

    private void Hover(ObservableCollection<Step> steps, Step step)
    {
        _hoveringIndex = steps.IndexOf(step);
    }

    private void Drop(ObservableCollection<Step> steps, Step step)
    {
        steps.Move(_draggingIndex, _hoveringIndex);
        _draggingIndex = -1;
        _hoveringIndex = -1;

        UpdateStepNumbering(steps);
    }

}